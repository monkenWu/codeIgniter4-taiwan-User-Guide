

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-TW" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-TW" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>使用 CodeIgniter 的模型 &mdash; CodeIgniter4 4.1.5 說明文件</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/js/citheme.js"></script>
        <script type="text/javascript" src="../_static/js/carbon.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/citheme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜尋" href="../search.html" />
    <link rel="next" title="使用實體類別" href="entities.html" />
    <link rel="prev" title="資料模型化" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #DD4814" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/ci-logo-text.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/index.html">歡迎加入 CodeIgniter4</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/index.html">歡迎加入 CodeIgniter4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/requirements.html">系統需求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/credits.html">貢獻</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/psr.html">PSR 規範</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">安裝指引</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation/installing_composer.html">Composer 安裝</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/installing_manual.html">手動安裝</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/running.html">運作你的應用程式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/upgrading.html">從舊版升級</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/troubleshooting.html">故障排除</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/repositories.html">CodeIgniter 儲存庫</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">建構第一個應用程式</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/static_pages.html">靜態頁面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/news_section.html">新聞頁面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/create_news_items.html">建立新聞</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/conclusion.html">結論</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../concepts/index.html">CodeIgniter4 概觀</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/structure.html">應用程式結構</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/mvc.html">模型、視圖與控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/autoloader.html">自動載入檔案</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/services.html">服務（services）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/factories.html">工廠模式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/http.html">處裡 HTTP 請求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/security.html">安全指南</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../general/index.html">一般主題</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../general/configuration.html">組態設定檔案</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/urls.html">CodeIgniter URLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/helpers.html">輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/common_functions.html">全域函數與常數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/logging.html">記錄日誌資訊</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/errors.html">錯誤處理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/caching.html">網頁快取</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/ajax.html">AJAX 請求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/modules.html">程式碼模組</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/managing_apps.html">管理你的應用程式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/environments.html">處理多種環境</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../incoming/index.html">控制器與路由</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../incoming/controllers.html">控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/routing.html">URI 路由設定</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/filters.html">控制器過濾器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/message.html">HTTP 訊息</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/request.html">Request 類別</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/incomingrequest.html">訪問請求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/content_negotiation.html">內容協商</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/methodspoofing.html">HTTP 類型偽裝</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/restful.html">處理 RESTful 請求資源</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../outgoing/index.html">建構響應</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/views.html">視圖</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_cells.html">視圖單元</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_renderer.html">視圖渲染</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_layouts.html">視圖布局</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_parser.html">視圖解釋器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/table.html">HTML 表格類別</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/response.html">HTTP 響應</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/api_responses.html">API 響應特性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/localization.html">本土化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/alternative_php.html">用於視圖檔案的 PHP 語法</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">資料庫操作</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/examples.html">快速入門: 範例程式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/configuration.html">資料庫組態設定</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/connecting.html">連接你的資料庫</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/queries.html">執行查詢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/results.html">產生查詢結果</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/helpers.html">查詢輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/query_builder.html">查詢生成器類別</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/transactions.html">交易</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/metadata.html">詮釋資料</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/call_function.html">自訂函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/events.html">資料庫事件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/utilities.html">資料庫工具</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">資料模型化</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">使用 CodeIgniter 的模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="entities.html">使用實體類別</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dbmgmt/index.html">資料庫管理</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/forge.html">資料庫操控與資料庫建構</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/migration.html">資料庫遷移</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/seeds.html">資料庫填充</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../libraries/index.html">程式庫參考</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../libraries/caching.html">Caching Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/cookies.html">Cookies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/curlrequest.html">CURLRequest Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/email.html">Email Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/encryption.html">加密服務</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/files.html">Working with Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/files.html#file-collections">File Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/honeypot.html">誘捕系統類別</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/images.html">Image Manipulation Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/pagination.html">Pagination</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/publisher.html">Publisher</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/security.html">安全性類別</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/sessions.html">Session Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/throttler.html">Throttler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/time.html">Times and Dates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/typography.html">Typography</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/uploaded_files.html">Working with Uploaded Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/uri.html">Working with URIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/user_agent.html">User Agent Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/validation.html">Validation</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../helpers/index.html">輔助函數</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../helpers/array_helper.html">陣列輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/cookie_helper.html">Cookie 輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/date_helper.html">日期輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/filesystem_helper.html">檔案系統輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/form_helper.html">表單輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/html_helper.html">HTML Helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/inflector_helper.html">Inflector 輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/number_helper.html">Number 輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/security_helper.html">安全性輔助函數</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/test_helper.html">Test Helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/text_helper.html">Text Helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/url_helper.html">URL Helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/xml_helper.html">XML 輔助函數</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">測試</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing/overview.html">入門</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/database.html">資料庫測試</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/fabricator.html">Generating Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/controllers.html">控制器測試</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/feature.html">HTTP 特性測試</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/response.html">Testing Responses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/benchmark.html">基準測試</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/debugging.html">偵錯與除錯應用程式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/mocking.html">Mocking</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">使用命令列介面</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli.html">透過命命列運作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_commands.html">自訂命令列介面指令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_generators.html">CLI Generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_library.html">命令列程式庫</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_request.html">CLI 請求類別</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">擴充 CodeIgniter</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../extending/core_classes.html">建立核心系統類別</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/common.html">替換常用功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/events.html">事件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/basecontroller.html">擴充控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/authentication.html">認證方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/contributing.html">為 CodeIgniter 貢獻</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translation/index.html">CodeIgniter4 文件翻譯</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../translation/glossary.html">詞彙對照表</a></li>
<li class="toctree-l2"><a class="reference internal" href="../translation/members.html">翻譯貢獻者</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CodeIgniter4</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">資料模型化</a> &raquo;</li>
        
      <li>使用 CodeIgniter 的模型</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="codeigniter">
<h1>使用 CodeIgniter 的模型<a class="headerlink" href="#codeigniter" title="本標題的永久連結">¶</a></h1>
<div class="contents local topic" id="id1">
<ul class="simple">
<li><a class="reference internal" href="#id2" id="id23">模型</a></li>
<li><a class="reference internal" href="#id3" id="id24">存取模型</a></li>
<li><a class="reference internal" href="#codeigniter-model" id="id25">CodeIgniter 的 Model</a></li>
<li><a class="reference internal" href="#id4" id="id26">建立你的模型</a><ul>
<li><a class="reference internal" href="#id5" id="id27">連接資料庫</a></li>
<li><a class="reference internal" href="#id6" id="id28">設定你的模型</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7" id="id29">資料作業</a><ul>
<li><a class="reference internal" href="#id8" id="id30">尋找資料</a></li>
<li><a class="reference internal" href="#id9" id="id31">儲存資料</a></li>
<li><a class="reference internal" href="#id10" id="id32">刪除資料</a></li>
<li><a class="reference internal" href="#id11" id="id33">驗證資料</a></li>
<li><a class="reference internal" href="#id12" id="id34">檢索驗證規則</a></li>
<li><a class="reference internal" href="#id13" id="id35">驗證置換符號</a></li>
<li><a class="reference internal" href="#id14" id="id36">保護欄位</a></li>
<li><a class="reference internal" href="#id15" id="id37">操作查詢生成器</a></li>
<li><a class="reference internal" href="#id16" id="id38">轉換回傳型別</a></li>
<li><a class="reference internal" href="#id17" id="id39">處理大量資料</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18" id="id40">模型事件</a><ul>
<li><a class="reference internal" href="#id19" id="id41">定義回呼</a></li>
<li><a class="reference internal" href="#id20" id="id42">指定要運作的回呼</a></li>
<li><a class="reference internal" href="#id21" id="id43">事件參數</a></li>
<li><a class="reference internal" href="#find" id="id44">修改 Find* 資料</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id22" id="id45">創建手動模型</a></li>
</ul>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id23">模型</a><a class="headerlink" href="#id2" title="本標題的永久連結">¶</a></h2>
<p>模型提供一種與資料庫中特定資料表互動的方法，模型也內建輔助方法，讓你在與資料庫資料表互動的過程中有標準的方法可以呼叫，包括查找記錄、更新記錄，刪除記錄等等。</p>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id24">存取模型</a><a class="headerlink" href="#id3" title="本標題的永久連結">¶</a></h2>
<p>模型通常會儲存在 <code class="docutils literal notranslate"><span class="pre">app/Models</span></code> 目錄下，通常它們會有一個與它們所在位置相同的命名空間，比如這個命名空間： <code class="docutils literal notranslate"><span class="pre">namespace</span> <span class="pre">App\Models</span></code> 。</p>
<p>你可以透過創造一個新的實體或是使用 <code class="docutils literal notranslate"><span class="pre">model()</span></code> 輔助函數來造訪類別中的模型。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="c1">// 手動建立新類別</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\App\Models\UserModel</span><span class="p">();</span>

<span class="c1">// 使用模型函數建立新類別</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;App\Models\UserModel&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>

<span class="c1">// 使用模型函數共享模型實體</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;App\Models\UserModel&#39;</span><span class="p">);</span>

<span class="c1">// 使用你所提供的資料庫連接建立共享實體</span>
<span class="c1">// 如果沒有傳入命名空間那它將會搜索所有的命名空間</span>
<span class="c1">// 系統將會嘗試定位 UserModel 類別</span>
<span class="nv">$db</span> <span class="o">=</span> <span class="nx">db_connect</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">);</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;UserModel&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$db</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="codeigniter-model">
<h2><a class="toc-backref" href="#id25">CodeIgniter 的 Model</a><a class="headerlink" href="#codeigniter-model" title="本標題的永久連結">¶</a></h2>
<p>CodeIgniter 支援了模型類別，它提供了一些很好的功能，包括：</p>
<ul class="simple">
<li>自動連接資料庫</li>
<li>基本的 CRUD 方法</li>
<li>模型內驗證</li>
<li>自動分頁</li>
<li>更多更多方法</li>
</ul>
<p>這個類別提供了一個很強鍵的基礎，你可以在這個基礎上建立自己的模型，讓你可以快速地建構出應用程式的模型層。</p>
</div>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id26">建立你的模型</a><a class="headerlink" href="#id4" title="本標題的永久連結">¶</a></h2>
<p>若你需要利用 CodeIgniter 的模型，你只需要創建一個新的模型類別，並且使其繼承 <code class="docutils literal notranslate"><span class="pre">CodeIgniter\Model</span></code> ：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>這個空的類別提供了對資料庫連接、查詢生成器，和一些額外的便捷方法的存取。</p>
<p>如果你需要在模型中進行其他的設定，可以選擇覆寫父類別 <code class="docutils literal notranslate"><span class="pre">initialize()</span></code> 方法。這個函數將在模型的建構函數執行完畢時立即執行。它允許你在不重複撰寫建構函數參數的情況下執行額外的步驟，例如繼承其它模型：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Modules\Authentication\Models\UserAuthModel</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">UserAuthModel</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * Called during initialization. Appends</span>
<span class="sd">     * our custom field to the module&#39;s model.</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">allowedFields</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">&#39;middlename&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id27">連接資料庫</a><a class="headerlink" href="#id5" title="本標題的永久連結">¶</a></h3>
<p>當類別被首次實體化後，如果沒有向建構方法傳遞資料庫的連結實體，那麼它將會自動連接到組態設定中預設的資料庫群組。你可以透過在類別中添加 DBGroup 屬性來修改每個模型會使用到的資料庫設定群組。這樣可以讓模型中任何對 <code class="docutils literal notranslate"><span class="pre">$this-&gt;db</span></code> 的呼叫引用，都是透過你所設定適合的連接執行。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$DBGroup</span> <span class="o">=</span> <span class="s1">&#39;group_name&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>你可以把 「group_name」 替換成資料庫組態設定檔案中定義的資料庫群組名稱。</p>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id28">設定你的模型</a><a class="headerlink" href="#id6" title="本標題的永久連結">¶</a></h3>
<p>模型類別有幾個設定選項，可以透過設定這些選項讓「類別」方法無縫地為你工作。前兩個是所有 CRUD 需求都會用到的屬性，決定著我們需要使用什麼資料表，以及如何找到所需的記錄。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$table</span>      <span class="o">=</span> <span class="s1">&#39;users&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$primaryKey</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$useAutoIncrement</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$returnType</span>     <span class="o">=</span> <span class="s1">&#39;array&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$useSoftDeletes</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$allowedFields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">];</span>

    <span class="k">protected</span> <span class="nv">$useTimestamps</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$createdField</span>  <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$updatedField</span>  <span class="o">=</span> <span class="s1">&#39;updated_at&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$deletedField</span>  <span class="o">=</span> <span class="s1">&#39;deleted_at&#39;</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$validationRules</span>    <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$skipValidation</span>     <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>$table</strong></p>
<p>指定這個模型主要配合的資料表，這只適用於模型內建的 CRUD 方法，並不會限制你在你自己的查詢內一定得用這個表。</p>
<p><strong>$primaryKey</strong></p>
<p>你所選擇的資料表中資料記錄的唯一識別符號，它不一定要與資料庫中資料表的主鍵欄位相同，而是你在使用像是 <code class="docutils literal notranslate"><span class="pre">find()</span></code> 這種方法時，模型可以知道要將指定值以哪個欄位進行搜索。</p>
<div class="admonition note">
<p class="first admonition-title">備註</p>
<p class="last">所有模型必須指定一個 $primaryKey ，以使所有功能可以正常工作。</p>
</div>
<p><strong>$useAutoIncrement</strong></p>
<p>指定資料表是否對 <code class="docutils literal notranslate"><span class="pre">$primaryKey</span></code> 使用自動遞增功能。如果它被宣告為 <code class="docutils literal notranslate"><span class="pre">false</span></code> ，則由你負責提供資料表中每條紀錄得主鍵。當我們想要實作出一對一關係時或對模型使用 UUID 時，這會是個方便的功能。</p>
<div class="admonition note">
<p class="first admonition-title">備註</p>
<p class="last">如果你宣告 <code class="docutils literal notranslate"><span class="pre">$useAutoIncrement</span></code> 為 <code class="docutils literal notranslate"><span class="pre">false</span></code> ，請保證資料庫中的主鍵為 <code class="docutils literal notranslate"><span class="pre">unique</span></code> 。透過這個方式才能保證 Model 所有功能能夠照常工作。</p>
</div>
<p><strong>$returnType</strong></p>
<p>模型提供的 CRUD 方法將幫助你減少工作量，並自動回傳結果資料，而不適普的的資料庫結果物件。這個設定允許你宣告回傳的資料類型。你可以鍵入 array 或是 object ，或者可以與結果物件的 getCustomResultObject() 方法一起使用完整的類別名稱。</p>
<p><strong>$useSoftDeletes</strong></p>
<p>如果這個值為 true ，那麼任何 delete 方法的呼叫都會在資料庫中修改 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code> 欄位，而不是直接刪除該筆資料。當資料可能在其他地方被引用時，這個功能可以替你將資料保存下來，也可以作為「資源回收桶」，讓被刪除的物件有被還原的可能，甚至你也可以將其保留下來做為未來安全性追蹤的依據。若是資料被設為刪除，你還是想呼叫到這筆資料，則必須在 find() 方法前先呼叫 withDeleted() 方法，否則 find() 方法只會回傳未被刪除的資料。</p>
<p>若你要使用這個功能，你需要在資料庫中建立型別為 DATETIME 或 INTEGER 的欄位，其名稱必須在 $dateFormat 成員屬性中定義，這個成員變數的值必須與資料庫的欄位名稱相同。而 $dateFormat 的預設名稱為 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code> 。</p>
<p><strong>$allowedFields</strong></p>
<p>在這個陣列中被記錄的欄位名稱都將在使用保存、插入，或更新方法期間被允許，而沒有被記錄的欄位名稱將被丟棄。這有助於防止將未處理的表單資訊直接傳遞給模型處理時，導致的自動綁定漏洞。</p>
<p><strong>$useTimestamps</strong></p>
<p>這個屬性的型別為布林，它決定了在執行插入與更新的方法時，是否會自動更新時間戳。如果為 true 將以 $dateFormat 屬性所指定格式，產出目前的時間記錄並存在的固定的欄位中。這個功能需要在資料庫中以適當的型別建立 「created_at」 以及 「updated_at」 欄位。</p>
<p><strong>$createdField</strong></p>
<p>指定使用哪個資料庫欄位來保存資料在創建時的時間戳，請將其留空並避免更新這個欄位（即使啟動了 <code class="docutils literal notranslate"><span class="pre">$useTimestamps</span></code> 功能）。</p>
<p><strong>$updatedField</strong></p>
<p>指定使用哪個資料庫欄位來保存資料在更新時的時間戳，請將其留空並避免更新這個欄位（即使啟動了 <code class="docutils literal notranslate"><span class="pre">$useTimestamps</span></code> 功能）。</p>
<p><strong>$dateFormat</strong></p>
<p>這個屬性將與 $useTimestamps 與 $useSoftDeletes 一起運作，確保正確的日期被插入到資料庫中。在預設的情形下，這個值會創建 DATETIME 型別的值，而這個屬性可以設定的選項為： datetime 、date 、int （ PHP 時間戳）。</p>
<p><strong>$validationRules</strong></p>
<p>這個屬性將會是驗證程式庫的 <a class="reference internal" href="../libraries/validation.html#validation-array"><span class="std std-ref">How to save your rules</span></a> （如何保存規則）條目中所描述的驗證用陣列，或是驗證群組名稱的字串，下面將會更詳細地闡述。</p>
<p><strong>$validationMessages</strong></p>
<p>你將在這個屬性中儲存，驗證過程中你所設定的 <a class="reference internal" href="../libraries/validation.html#validation-custom-errors"><span class="std std-ref">Setting Custom Error Messages</span></a> （自訂錯誤消息）的陣列，下面將會有更詳細地闡述。</p>
<p><strong>$skipValidation</strong></p>
<p>這個屬性決定在進行 <code class="docutils literal notranslate"><span class="pre">更新</span></code> 與 <code class="docutils literal notranslate"><span class="pre">插入</span></code> 的過程中，是否會跳過驗證。預設值為 false ，這代表若沒有另外賦予值，模型將始終進行驗證。這個屬性主要由 <code class="docutils literal notranslate"><span class="pre">skipValidation()</span></code> 方法使用，你也可以將這個屬性改為 <code class="docutils literal notranslate"><span class="pre">true</span></code> ，讓模型永遠不要進行驗證。</p>
<p><strong>$beforeInsert</strong>
<strong>$afterInsert</strong>
<strong>$beforeUpdate</strong>
<strong>$afterUpdate</strong>
<strong>afterFind</strong>
<strong>afterDelete</strong></p>
<p>這些陣列允許你宣告需要執行的回呼方法，並在你指定的事件發生時執行。</p>
<p><strong>$allowCallbacks</strong></p>
<p>是否允許使用上述回呼方法。</p>
</div>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id29">資料作業</a><a class="headerlink" href="#id7" title="本標題的永久連結">¶</a></h2>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id30">尋找資料</a><a class="headerlink" href="#id8" title="本標題的永久連結">¶</a></h3>
<p>在尋找資料方面，模型提供了幾個函數來對資料表進行基礎的 CRUD 工作，包括：find()、insert()、 update()、 delete() 等等。</p>
<p><strong>find()</strong></p>
<p>以傳入的主鍵搜索資料，將會回傳一筆符合的資料：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">);</span>
</pre></div>
</div>
<p>你的查詢將會以 $returnType 指定的資料型別回傳。</p>
<p>你可以透過傳入一個以主鍵組成的陣列，來取得多筆資料：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<p>如果沒有傳入任何參數，那麼將會回傳這個模型所指定的資料表中所有的記錄。雖然表示的函數名稱沒有像 findAll() 一樣這麼直覺，但效果是相同的。</p>
<p><strong>findColumn()</strong></p>
<p>回傳 null 或是一個具有索引的欄位結果陣列。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findColumn</span><span class="p">(</span><span class="nv">$column_name</span><span class="p">);</span>
</pre></div>
</div>
<p>$column_name 應該要是單個欄位的名稱，若否你則會獲得 DataException 這個例外的拋出。</p>
<p><strong>findAll()</strong></p>
<p>回傳所有結果。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p>在呼叫這個方法之前，可以根據自己的需求從中間插入查詢生成器的語法，來修改這個查詢。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p>你也可以傳入兩個參數，分別代表偏移與限制。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="nv">$limit</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>first()</strong></p>
<p>將一定會回傳第一筆結果，這個功能最好與查詢生成器結合使用。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
</pre></div>
</div>
<p><strong>withDeleted()</strong></p>
<p>如果 $useSoftDeletes 為 true ，那麼 find() 方法將會以 「deleted_at IS NOT NULL」 這個條件執行資料庫查詢，不會回傳任何被假性刪除的記錄。當然，你若是需要這筆資料，就要在 find() 方法以前使用這個方法：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="c1">// Only gets non-deleted rows (deleted = 0)</span>
<span class="nv">$activeUsers</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>

<span class="c1">// Gets all rows</span>
<span class="nv">$allUsers</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">withDeleted</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p><strong>onlyDeleted()</strong></p>
<p>withDeleted() 方法將會回傳已經刪除與未刪除的記錄，而這個方法將會修改下一個生效的 find() 方法，使它只會回傳被假性刪除的資料。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$deletedUsers</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">onlyDeleted</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id31">儲存資料</a><a class="headerlink" href="#id9" title="本標題的永久連結">¶</a></h3>
<p><strong>insert()</strong></p>
<p>這個方法允許你傳入一個鍵值陣列，使你可以在資料庫中插入一筆新資料。你所傳入的陣列的鍵必須與資料庫的欄位名稱相符，而每個鍵的值則是你所需要儲存的資料。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>insertBatch()</strong></p>
<p>若是你需要一次插入多筆資料進資料庫中，你需要傳入一個包含上一個條目 insert() 使用的陣列的陣列。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span>
        <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span>
    <span class="p">],</span>
    <span class="p">[</span>
        <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;amos&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;a.vader@theempire.com&#39;</span>
    <span class="p">]</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">insertBatch</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>update()</strong></p>
<p>更新資料庫的現有記錄，第一個參數是你目標更新資料的 $primaryKey ，而第二個參數則是一個鍵值陣列。陣列的鍵必須與資料表中的欄位名稱相符，而每個鍵的值則是你所要更新的資料。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<p>透過傳入一個以主鍵組成的陣列作為第一個參數，可以只用一次呼叫更新多筆記錄。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;active&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<p>當你出現一些額外的需求時，你可以把傳入的參數留白，這個方法便會成為查詢生成器的更新指令一樣，讓你可以進行額外的驗證、事件等功能。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$userModel</span>
    <span class="o">-&gt;</span><span class="na">whereIn</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">set</span><span class="p">([</span><span class="s1">&#39;active&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">update</span><span class="p">();</span>
</pre></div>
</div>
<p><strong>save()</strong></p>
<p>這個功能它封裝了 insert() 與 update() 兩個方法。它依據在資料表中是否找的到你所傳入的 $primaryKey 主鍵，自動處理你所需要的是插入或是更新。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span>    <span class="c1">// 定義 model 屬性</span>
<span class="nv">$primaryKey</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">;</span>

    <span class="c1">// 執行 insert()</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

    <span class="c1">// 如果找的到你所傳入的主健，將會執行 update()</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;id&#39;</span>       <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<p>save() 方法還可以傳入一個物件並自動取得這個物件的公開屬性和保護屬性，然後將它們保存成相應的陣列，傳入到插入或更新的方法中。這種方式允許你使用簡潔的實體類別，它表示的是一個物件類型的單一實體。比如使用者、部落格文章、作業等。這個類別負責維護圍繞著物件本身的商業邏輯，例如：以某種方法格式化元素等。它不應該有任何將資料儲存到資料庫的邏輯，最簡單的使用方式如下所示：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nx">App\Entities</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Job</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$description</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__get</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">property_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$key</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__set</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">property_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$key</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>一個對應實體類別的最簡模型可能會像這個樣子：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$table</span> <span class="o">=</span> <span class="s1">&#39;jobs&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$returnType</span> <span class="o">=</span> <span class="s1">&#39;\App\Entities\Job&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$allowedFields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>這個模型使用 <code class="docutils literal notranslate"><span class="pre">jobs</span></code> 資料表來運作，並將所有結果以 <code class="docutils literal notranslate"><span class="pre">App\Entities\Job</span></code> 的一個實體回傳。當你需要將這個記錄儲存到資料庫時，你需要撰寫自定方法，使用模型提供的 <code class="docutils literal notranslate"><span class="pre">save()</span></code> 方法檢查類別、獲取公開屬性與私有屬性並將它們儲存到資料庫中。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="c1">// 獲取你所指定的 Job 實體</span>
<span class="nv">$job</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

<span class="c1">// 執行一些改變</span>
<span class="nv">$job</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s2">&quot;Foobar&quot;</span><span class="p">;</span>

<span class="c1">// 儲存改變</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">備註</p>
<p class="last">如果你發現自己需要使用實體來建構程式，CodeIgniter 提供了一個內建的 <a class="reference internal" href="entities.html"><span class="doc">實體類別</span></a> ，它提供了幾個方便的功能，讓開發實體變得更加簡單。</p>
</div>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id32">刪除資料</a><a class="headerlink" href="#id10" title="本標題的永久連結">¶</a></h3>
<p><strong>delete()</strong></p>
<p>傳入主鍵作為參數，將刪除模型所指定的資料表符合的記錄。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
</pre></div>
</div>
<p>如果模型的 $useSoftDeletes 為 true，則會將作為假性刪除判斷依據的 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code> 欄位寫入當下的日期和時間。你可以在第二個參數傳入 true 來強制執行永久刪除。</p>
<p>傳入以主鍵組成的陣列，可以一次刪除多個記錄。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<p>如果沒有傳入參數，就會像查詢生成器的刪除方法一樣，在這之前你會需要呼叫 where 相關的查詢生成器函數。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
</pre></div>
</div>
<p><strong>purgeDeleted()</strong></p>
<p>透過完全清除軟性刪除的記錄來清理資料表（符合 「deleted_at IS NOT NULL」 這個條件）。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">purgeDeleted</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id33">驗證資料</a><a class="headerlink" href="#id11" title="本標題的永久連結">¶</a></h3>
<p>對許多人來說，在模型中實作資料驗證，將會是減少程式碼重複的不二方法。模型類別提供在使用 <code class="docutils literal notranslate"><span class="pre">insert()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 、 或 <code class="docutils literal notranslate"><span class="pre">save()</span></code> 方法保存在資料庫之前，自動讓所有資料進行驗證。</p>
<p>第一步，你需要在 <code class="docutils literal notranslate"><span class="pre">$validationRules</span></code> 這個類別屬性中，宣告需要應用驗證的欄位與規則。如果你想要使用自定的錯誤訊息，請將它們放在
<code class="docutils literal notranslate"><span class="pre">$validationMessages</span></code> 陣列。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$validationRules</span>    <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;username&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;required|alpha_numeric_space|min_length[3]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;required|valid_email|is_unique[users.email]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;required|min_length[8]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pass_confirm&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required_with[password]|matches[password]&#39;</span>
    <span class="p">];</span>

    <span class="k">protected</span> <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;email&#39;</span>        <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;is_unique&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sorry. That email has already been taken. Please choose another.&#39;</span>
        <span class="p">]</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>另一種方法是利用函數設定欄位與驗證規則：</p>
<dl class="function">
<dt id="setValidationRule">
<code class="descname">setValidationRule</code><span class="sig-paren">(</span><em>$field</em>, <em>$fieldRules</em><span class="sig-paren">)</span><a class="headerlink" href="#setValidationRule" title="本定義的永久連結">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">參數:</th><td class="field-body"><ul class="first last simple">
<li><strong>$field</strong> (<em>string</em>) – </li>
<li><strong>$fieldRules</strong> (<em>array</em>) – </li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>這個函數可以設定欄位驗證規則。</p>
<p>使用範例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$fieldName</span> <span class="o">=</span> <span class="s1">&#39;username&#39;</span><span class="p">;</span>
<span class="nv">$fieldRules</span> <span class="o">=</span> <span class="s1">&#39;required|alpha_numeric_space|min_length[3]&#39;</span><span class="p">;</span>

<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationRule</span><span class="p">(</span><span class="nv">$fieldName</span><span class="p">,</span> <span class="nv">$fieldRules</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="setValidationRules">
<code class="descname">setValidationRules</code><span class="sig-paren">(</span><em>$validationRules</em><span class="sig-paren">)</span><a class="headerlink" href="#setValidationRules" title="本定義的永久連結">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">參數:</th><td class="field-body"><ul class="first last simple">
<li><strong>$validationRules</strong> (<em>array</em>) – </li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>這個函數可以設定驗證規則。</p>
<p>使用範例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|alpha_numeric_space|min_length[3]&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;rules&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;required|valid_email|is_unique[users.email]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;errors&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;We really need your email.&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
<span class="p">];</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationRules</span><span class="p">(</span><span class="nv">$validationRules</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<p>另一種方式是透過函數設定欄位的驗證訊息。</p>
<dl class="function">
<dt id="setValidationMessage">
<code class="descname">setValidationMessage</code><span class="sig-paren">(</span><em>$field</em>, <em>$fieldMessages</em><span class="sig-paren">)</span><a class="headerlink" href="#setValidationMessage" title="本定義的永久連結">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">參數:</th><td class="field-body"><ul class="first last simple">
<li><strong>$field</strong> (<em>string</em>) – 欄位名稱</li>
<li><strong>$fieldMessages</strong> (<em>array</em>) – 欄位錯誤訊息</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>這個函數將設定欄位的錯誤訊息。</p>
<p>使用範例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$fieldName</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span><span class="p">;</span>
<span class="nv">$fieldValidationMessage</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;required&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;Your name is required here&#39;</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationMessage</span><span class="p">(</span><span class="nv">$fieldName</span><span class="p">,</span> <span class="nv">$fieldValidationMessage</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="setValidationMessages">
<code class="descname">setValidationMessages</code><span class="sig-paren">(</span><em>$fieldMessages</em><span class="sig-paren">)</span><a class="headerlink" href="#setValidationMessages" title="本定義的永久連結">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">參數:</th><td class="field-body"><ul class="first last simple">
<li><strong>$fieldMessages</strong> (<em>array</em>) – 欄位訊息</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>這個方法可以設定欄位訊息。</p>
<p>使用範例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$fieldValidationMessage</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;required&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;Your baby name is missing.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;min_length&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Too short, man!&#39;</span><span class="p">,</span>
        <span class="p">],</span>
<span class="p">];</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationMessages</span><span class="p">(</span><span class="nv">$fieldValidationMessage</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<p>現在，每當你呼叫 <code class="docutils literal notranslate"><span class="pre">insert()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">update()</span></code> ，或 <code class="docutils literal notranslate"><span class="pre">save()</span></code> 方法時，資料將會被自動驗證。如果驗證失敗，模型將會回傳 <strong>false</strong> 。你可以使用 <code class="docutils literal notranslate"><span class="pre">error()</span></code> 方法來存取驗證錯誤：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">&#39;updateUser&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;errors&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>這將回傳一個包含欄位名稱和相關錯誤訊息的陣列，可以用來在表單的頂部顯示所有錯誤，你也可以單獨顯示它們：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span> <span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;alert alert-danger&quot;</span><span class="p">&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$errors</span> <span class="k">as</span> <span class="nv">$field</span> <span class="o">=&gt;</span> <span class="nv">$error</span><span class="p">)</span> <span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$error</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">endforeach</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
<p>如果你想在組態設定檔案中統一組織驗證用的規則以及錯誤訊息，只需將 <code class="docutils literal notranslate"><span class="pre">$validationRules</span></code> 設定為你所創建的規則群組名稱即可，就像這樣做：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id34">檢索驗證規則</a><a class="headerlink" href="#id12" title="本標題的永久連結">¶</a></h3>
<p>你可以透過模型的 <code class="docutils literal notranslate"><span class="pre">validationRules</span></code> 屬性來檢索模型的驗證規則。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">validationRules</span><span class="p">;</span>
</pre></div>
</div>
<p>你也可以透過直接呼叫 getValidationRules() 方法，用選項來檢索這些規則的一個子集。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getValidationRules</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">$options</span></code> 參數是一個鍵值陣列，包含著鍵為 「except」 或 「only」 的元素，這個鍵對應的數值則為你想查閱的欄位名稱陣列。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="c1">// 取得除了 username 欄位以外的所有規則</span>
<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getValidationRules</span><span class="p">([</span><span class="s1">&#39;except&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]]);</span>
<span class="c1">// 只取得 city 與 state 欄位的規則</span>
<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getValidationRules</span><span class="p">([</span><span class="s1">&#39;only&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">]]);</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id35">驗證置換符號</a><a class="headerlink" href="#id13" title="本標題的永久連結">¶</a></h3>
<p>模型提供了一個簡單的方法，可以根據你所傳入的資料替換掉規則的一部份。這聽請起來可以會有點艱深晦澀，但在 <code class="docutils literal notranslate"><span class="pre">is_unique</span></code> 驗證規則中相當便利。置換符號是以 $data 的形式傳入欄位（或是鍵值陣列）的名稱，這個陣列的 <strong>值</strong> 將會取代在目標字串中被大括弧包圍的相符欄位，這個例子應該可以充分說明這個功能：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|valid_email|is_unique[users.email,id,{id}]&#39;</span>
<span class="p">];</span>
</pre></div>
</div>
<p>在這個規則中，它規定除了具有置換符號的值相符的 id 記錄外，電子郵件的位置在資料庫中應該是唯一值，我們假設表單中的 POST 資料具有以下內容：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$_POST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo@example.com&#39;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>那麼 <code class="docutils literal notranslate"><span class="pre">{id}</span></code> 置換符號將被替換成數字 <strong>4</strong> ，因此被置換成下列的規則：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|valid_email|is_unique[users.email,id,4]&#39;</span>
<span class="p">];</span>
</pre></div>
</div>
<p>因此，當它所驗證的電子郵件是唯一值，就會忽略 <code class="docutils literal notranslate"><span class="pre">id=4</span></code> 的記錄。</p>
<p>這也可以用來在驗證的執行期間創建更動態的規則，你只需要注意傳入的動態鍵不要與表單的資料衝突即可。</p>
</div>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id36">保護欄位</a><a class="headerlink" href="#id14" title="本標題的永久連結">¶</a></h3>
<p>為了防止大規模的自動綁定攻擊，模型類別將 <strong>要求</strong> 你在 <code class="docutils literal notranslate"><span class="pre">$allowedFields</span></code> 類別屬性中列出，所有可以在插入和更新時更改的欄位名稱。除了這些之外的任何資料都將在進入資料庫之前被刪除，在保護時間戳或主鍵不被改變這件事情上，這是非常有用處的。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="nv">$allowedFields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">];</span>
</pre></div>
</div>
<p>有時，你會發現你可能需要改變這些元素，這個需求通常會在測試、遷移，或資料填充的期間出現。在這種情形下，你可以開啟或關閉保護。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">protect</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">protect</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id37">操作查詢生成器</a><a class="headerlink" href="#id15" title="本標題的永久連結">¶</a></h3>
<p>你可以在任何需要的時候，使用模型資料庫連接所提供的查詢生成器的共享實體。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$builder</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">builder</span><span class="p">();</span>
</pre></div>
</div>
<p>這個生成器已經在模型中的 $table 設定好了。如果你需要存取另一張表，你可以把它作為一個參數傳進去，但要注意使用這種方式獲得的並不是共享實體。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$groupBuilder</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">builder</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>你還可以在同一個鏈式呼叫中優雅地混和使用查詢生成器方法與模型提供的 CRUD 方法。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;last_login&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">)</span>
                   <span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">備註</p>
<p>你也可以無縫地造訪模型地資料庫連接：</p>
<div class="last highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$user_name</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">escape</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id16">
<h3><a class="toc-backref" href="#id38">轉換回傳型別</a><a class="headerlink" href="#id16" title="本標題的永久連結">¶</a></h3>
<p>你可以透過模型的類別屬性 $returnType 來指定使用 find() 方法時的回傳資料型別。但有時你可能會希望以不同的格式回傳資料，模型提供了一些方法允許你這麼做。</p>
<div class="admonition note">
<p class="first admonition-title">備註</p>
<p class="last">這些方法只會改變下一次執行 find() 方法呼叫時的回傳型別，之後它將回復為預設值。</p>
</div>
<p><strong>asArray()</strong></p>
<p>下一次的 find() 方法將以鍵值陣列的形式回傳：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">asArray</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p><strong>asObject()</strong></p>
<p>下一次的 find() 將會把資料轉換為標準物件或自訂類別的實體回傳。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="c1">// 回傳標準物件</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">asObject</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>

<span class="c1">// 回傳自訂類別實體</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">asObject</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="id17">
<h3><a class="toc-backref" href="#id39">處理大量資料</a><a class="headerlink" href="#id17" title="本標題的永久連結">¶</a></h3>
<p>有的時候，你可能會需要處理大量的資料，說不定會有記憶體不足的問題。為了簡單化這個問題，你可以使用 chunk() 方法來獲取更小的資料塊，然後再進行工作。第一個參數是單個資料塊中被檢索的行數，第二個參數是一個匿名陣列，它將會呼叫每一行的資料。</p>
<p>這最好在排程工作、資料匯出與其他大型任務中使用。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">chunk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do something.</span>
    <span class="c1">// $data is a single row of data.</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id18">
<h2><a class="toc-backref" href="#id40">模型事件</a><a class="headerlink" href="#id18" title="本標題的永久連結">¶</a></h2>
<p>在模型的執行的過程中，可以指定幾個時機執行數個回呼函數。這些方法可以用於正規化資料、雜湊密碼，以及儲存相關實體等等。以下提供數種方法來影響不同時機的執行行為：<strong>$beforeInsert</strong> 、 <strong>$afterInsert</strong> 、 <strong>$beforeUpdate</strong> 、 <strong>afterUpdate</strong> 、 <strong>afterFind</strong> 、以及 <strong>afterDelete</strong> 。</p>
<div class="section" id="id19">
<h3><a class="toc-backref" href="#id41">定義回呼</a><a class="headerlink" href="#id19" title="本標題的永久連結">¶</a></h3>
<p>首先，我們在模型中會創建一個新的類別方法來定義回呼。這個類別會接受一個 $data 陣列作為它的唯一參數。$data 陣列的確切內容會因事件的不同而相異，但總是會包含一個名為 <strong>data</strong> 的鍵，其中包含著傳遞給原始方法的主要資料——在插入或更新的方法下，這將是會被插入到資料庫的鍵值陣列。主要的陣列內容也會包含傳遞給其他方法的值，待會將會詳細的介紹。所有的回呼方法都必須回傳原始的 $data 陣列，這樣其他的回呼函數才能得到完整的訊息。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="k">function</span> <span class="nf">hashPassword</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]))</span> <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>

    <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">password_hash</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="nx">PASSWORD_DEFAULT</span><span class="p">);</span>
    <span class="nb">unset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>

    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id20">
<h3><a class="toc-backref" href="#id42">指定要運作的回呼</a><a class="headerlink" href="#id20" title="本標題的永久連結">¶</a></h3>
<p>你可以透過將方法名稱添加到相應的類別屬性（ beforeInsert 或 afterUpdate 等），來指定何時該運作哪個回呼。你也可以在一個事件中加入多個回呼，他們將相繼被處理。當然也可以在多個事件中使用同一個回呼。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="nv">$beforeInsert</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hashPassword&#39;</span><span class="p">];</span>
<span class="k">protected</span> <span class="nv">$beforeUpdate</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hashPassword&#39;</span><span class="p">];</span>
</pre></div>
</div>
<p>此外，每個模型都可以透過設定其 <code class="docutils literal notranslate"><span class="pre">$allowCallbacks</span></code> 屬性來允許（預設）或拒絕類別範圍的回呼：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="nv">$allowCallbacks</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</pre></div>
</div>
<p>你也可一透過 <code class="docutils literal notranslate"><span class="pre">allowCallbacks()</span></code> 臨時改變這個設定，在單次呼叫取消回呼。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">allowCallbacks</span><span class="p">(</span><span class="k">false</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// No callbacks triggered</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>                        <span class="c1">// Callbacks subject to original property value</span>
</pre></div>
</div>
</div>
<div class="section" id="id21">
<h3><a class="toc-backref" href="#id43">事件參數</a><a class="headerlink" href="#id21" title="本標題的永久連結">¶</a></h3>
<p>由於傳遞給每個回呼的確切資料存在著一些差異，下面將會詳列傳遞給每個事件的 $data 參數中的詳細內容：</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">事件</th>
<th class="head">$data 內容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>beforeInsert</td>
<td><strong>data</strong> = 即將被插入的鍵值陣列。如果一個物件或是實體類別被傳遞給插入方法，則會先將其轉換成陣列。</td>
</tr>
<tr class="row-odd"><td>afterInsert</td>
<td><strong>id</strong> = 新記錄的主鍵，若插入失敗則為 0 。
<strong>data</strong> = 被插入進資料庫的鍵值陣列。
<strong>result</strong> = 透過查詢生成器使用 insert() 方法的結果。</td>
</tr>
<tr class="row-even"><td>beforeUpdate</td>
<td><strong>id</strong> = 被更新的資料的主鍵。
<strong>data</strong> = 即將被更新的鍵值陣列，如果一個物件或實體類別被傳遞給插入方法，首先會先將其轉換成陣列。</td>
</tr>
<tr class="row-odd"><td>afterUpdate</td>
<td><strong>id</strong> = 被更新的資料主鍵。
<strong>data</strong> = 更新完成的鍵值陣列。
<strong>result</strong> = 透過查詢生成器使用 update() 方法的結果</td>
</tr>
<tr class="row-even"><td>beforeFind</td>
<td>呼叫　<strong>method</strong>　名稱，是否請求了 <strong>singleton</strong> 以及以下附加參數：</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li>first()</li>
</ul>
</td>
<td>沒有附加參數</td>
</tr>
<tr class="row-even"><td><ul class="first last simple">
<li>find()</li>
</ul>
</td>
<td><strong>id</strong> = 用於搜索的主鍵</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li>findAll()</li>
</ul>
</td>
<td><strong>limit</strong> = 所要搜索的列數。
<strong>offset</strong> = 搜索期間要跳過地列數。</td>
</tr>
<tr class="row-even"><td>afterFind</td>
<td>與 <strong>beforeFind</strong> 相同，但包括結果資料列；如果未找到結果，則為null。</td>
</tr>
<tr class="row-odd"><td>beforeDelete</td>
<td>將因為 delete 方法的不同而相異，請詳閱下方內容：</td>
</tr>
<tr class="row-even"><td><ul class="first last simple">
<li>delete()</li>
</ul>
</td>
<td><strong>id</strong> = 即將被刪除的主鍵。
<strong>purge</strong> = 布林，是否被完全刪除或假性刪除。</td>
</tr>
<tr class="row-odd"><td>afterDelete</td>
<td><strong>id</strong> = 被刪除的主鍵。
<strong>purge</strong> = 布林，是否被完全刪除或假性刪除。
<strong>result</strong> = 查詢生成器呼叫 delete() 的結果。
<strong>data</strong> = 未使用。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="find">
<h3><a class="toc-backref" href="#id44">修改 Find* 資料</a><a class="headerlink" href="#find" title="本標題的永久連結">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">beforeFind</span></code> 和 <code class="docutils literal notranslate"><span class="pre">afterFind</span></code> 方法都可以回傳一組修改後的資料集，用於重寫來自模型的正常響應。對於``afterFind`` 來說，回傳陣列中的 <code class="docutils literal notranslate"><span class="pre">data</span></code> 所做的任何更變都會自動傳遞到回呼方法。為了使 <code class="docutils literal notranslate"><span class="pre">beforeFind</span></code> 攔截 find 的工作流程，它還需要回傳一個額外的 <code class="docutils literal notranslate"><span class="pre">returnData</span></code> 。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="nv">$beforeFind</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;checkCache&#39;</span><span class="p">];</span>
<span class="c1">// ...</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">checkCache</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Check if the requested item is already in our cache</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$item</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCachedItem</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]))</span>
    <span class="p">{</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nv">$item</span><span class="p">;</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;returnData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="c1">// ...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id22">
<h2><a class="toc-backref" href="#id45">創建手動模型</a><a class="headerlink" href="#id22" title="本標題的永久連結">¶</a></h2>
<p>你不需要繼承任何的特殊類別來替你的應用程式創建一個模型。你只需要得到一個資料庫連接實體即可。這樣你就能繞過 CodeIgniter 的模型替你預先制定的功能，創建一個完全由你定義的手動模型。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Database\ConnectionInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$db</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="o">&amp;</span><span class="nv">$db</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$db</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="entities.html" class="btn btn-neutral float-right" title="使用實體類別" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="資料模型化" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019-2021 CodeIgniter 基金會 | 國立高雄師範大學軟體工程與管理學系 SDPM 實驗室譯製 
      <span class="lastupdated">
        最後更新於 2021年12月03日。
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>

  
  
    
   

</body>
</html>